From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Shane Freeder <theboyetronic@gmail.com>
Date: Wed, 13 Apr 2022 08:25:42 +0100
Subject: [PATCH] Prevent tile entity copies loading chunks


diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index e4d54fdc28b6161e74626f25299b1081e6605e98..3ab4ecb9ee3586cab04da7b500024855892faa3e 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -1,5 +1,6 @@
 package net.minecraft.server.network;
 
+import com.destroystokyo.paper.event.player.IllegalPacketEvent;
 import com.google.common.collect.Lists;
 import com.google.common.primitives.Floats;
 import com.mojang.brigadier.ParseResults;
@@ -2994,8 +2995,17 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
 
             if (!itemstack.isEmpty() && nbttagcompound != null && nbttagcompound.contains("x") && nbttagcompound.contains("y") && nbttagcompound.contains("z") && this.player.getBukkitEntity().hasPermission("minecraft.nbt.copy")) { // Spigot
                 BlockPos blockposition = BlockEntity.getPosFromTag(nbttagcompound);
-                BlockEntity tileentity = this.player.level.getBlockEntity(blockposition);
-
+                // Paper start
+                BlockEntity tileentity = null;
+                if (this.player.getLevel().isLoadedAndInBounds(blockposition)) {
+                    tileentity = this.player.level.getBlockEntity(blockposition);
+                } else {
+                    // failed to find, cleanup
+                    nbttagcompound.remove("x");
+                    nbttagcompound.remove("y");
+                    nbttagcompound.remove("z");
+                }
+                // Paper end
                 if (tileentity != null) {
                     tileentity.saveToItem(itemstack);
                 }
